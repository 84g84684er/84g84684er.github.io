<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IG圖片分割工具</title>
    <link rel="icon" href="./IGis.png" type="image/png">
    <!-- 引入 JSZip 函式庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --bg-main: #121212;
            --bg-surface: #1e1e1e;
            --bg-control: #2a2a2e;
            --bg-control-hover: #3a3a3e;
            --border-color: #4f4f52;
            --border-color-hover: #6f6f72;
            --text-primary: #f0f0f0;
            --text-secondary: #aaaaaa;
            --accent: #6c63ff; /* A modern accent color */
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            max-width: 800px;
            width: 100%;
            background-color: var(--bg-surface);
            padding: 30px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
        }
        h1 {
            text-align: center;
            color: var(--text-primary);
            margin-bottom: 25px;
            font-weight: 600;
        }
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
            border: 2px dashed #444;
            padding: 25px;
            border-radius: 12px;
        }
        .control-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 20px;
            width: 100%;
        }
        .btn {
            background-color: var(--bg-control);
            color: var(--text-primary);
            padding: 12px 24px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.1s ease;
        }
        .btn:hover {
            background-color: var(--bg-control-hover);
            border-color: var(--border-color-hover);
        }
        .btn:active {
            transform: scale(0.97);
        }
        .btn:disabled {
            background-color: #2a2a2e;
            border-color: #444;
            color: #777;
            cursor: not-allowed;
            transform: none;
        }
        .btn-small { padding: 6px 14px; font-size: 14px; margin-left: 8px; }
        .btn-secondary { background-color: transparent; border: 1px solid var(--accent); color: var(--accent); }
        .btn-secondary:hover { background-color: rgba(108, 99, 255, 0.1); }
        
        input[type="file"] { display: none; }

        .input-label-group { display: flex; align-items: center; gap: 12px; color: var(--text-secondary); }
        
        /* --- NEW: Custom Color Picker --- */
        .color-picker-wrapper {
            position: relative;
            width: 36px;
            height: 36px;
        }
        #color-preview {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid #555;
            box-sizing: border-box;
            transition: border-color 0.2s ease;
        }
        .color-picker-wrapper:hover #color-preview {
            border-color: #777;
        }
        #fill-color-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .bottom-controls {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-top: 15px;
        }
        .slider-container { display: flex; align-items: center; gap: 10px; color: var(--text-secondary); flex-grow: 1; }
        #size-slider {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 6px; background: #444;
            outline: none; border-radius: 3px;
        }
        #size-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 20px; height: 20px; background: var(--accent);
            cursor: pointer; border-radius: 50%;
        }
        #size-slider::-moz-range-thumb {
            width: 20px; height: 20px; background: var(--accent);
            cursor: pointer; border-radius: 50%; border: none;
        }

        #preview-container { margin: 25px auto 0 auto; display: grid; transition: width 0.2s ease-in-out, gap 0.3s ease; grid-template-columns: repeat(3, 1fr); }
        .grid-item { position: relative; }
        .preview-cropped { gap: 0 !important; }
        .crop-wrapper {
            aspect-ratio: 4 / 5; display: flex; justify-content: center; align-items: center;
            transition: aspect-ratio 0.3s ease; overflow: hidden;
            /* border-radius: 4px; -- REMOVED */
        }
        .preview-cropped .crop-wrapper { aspect-ratio: 3 / 4; }
        .crop-wrapper img { width: 100%; height: 100%; object-fit: cover; }

        .download-btn {
            position: absolute; bottom: 8px; right: 8px; background-color: rgba(0, 0, 0, 0.7); color: white;
            border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 50%; width: 32px; height: 32px;
            cursor: pointer; font-size: 16px; line-height: 30px; text-align: center;
            opacity: 0; transition: opacity 0.3s ease, transform 0.2s ease; text-decoration: none;
        }
        .grid-item:hover .download-btn { opacity: 1; transform: scale(1.1); }
        .info-text { text-align: center; color: var(--text-secondary); margin-top: 20px; }
        #download-all-container { text-align: center; margin-top: 25px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>IG圖片分割工具</h1>
        <div class="controls">
            <input type="file" id="image-input" accept="image/png, image/jpeg">
            <button class="btn" onclick="document.getElementById('image-input').click();">點擊上傳圖片</button>
            <div class="control-group">
                <div class="input-label-group">
                    <label>填充顏色：</label>
                    <!-- NEW HTML structure for color picker -->
                    <div class="color-picker-wrapper">
                         <div id="color-preview"></div>
                         <input type="color" id="fill-color-input" value="#000000">
                    </div>
                    <button id="apply-color-btn" class="btn btn-small">套用</button>
                </div>
            </div>
            <div id="image-options" style="display: none; width: 100%;">
                 <button class="btn" id="rotate-btn" style="width: 100%; margin-bottom: 15px;">旋轉圖片 ↻</button>
                 <div class="bottom-controls">
                    <div class="slider-container">
                        <label for="size-slider">大小: <span id="size-label">50%</span></label>
                        <input type="range" id="size-slider" min="25" max="100" value="50">
                    </div>
                     <button class="btn btn-secondary" id="preview-toggle-btn">預覽裁切</button>
                </div>
            </div>
        </div>
        <p id="info" class="info-text"></p>
        <div id="preview-container"></div>
        <div id="download-all-container" style="display: none;">
            <button class="btn" id="download-all-btn">下載全部 (ZIP)</button>
        </div>
    </div>

    <script>
        const imageInput = document.getElementById('image-input');
        const fillColorInput = document.getElementById('fill-color-input');
        const colorPreview = document.getElementById('color-preview'); // Get the new preview div
        const applyColorBtn = document.getElementById('apply-color-btn');
        const rotateBtn = document.getElementById('rotate-btn');
        const imageOptions = document.getElementById('image-options');
        const sizeSlider = document.getElementById('size-slider');
        const sizeLabel = document.getElementById('size-label');
        const previewToggleBtn = document.getElementById('preview-toggle-btn');
        const previewContainer = document.getElementById('preview-container');
        const infoText = document.getElementById('info');
        const downloadAllContainer = document.getElementById('download-all-container');
        const downloadAllBtn = document.getElementById('download-all-btn');
        
        let currentImage = null;
        let originalFileName = 'image';
        let currentRotation = 0;
        const COLS = 3;

        // --- Initialize Color Preview ---
        colorPreview.style.backgroundColor = fillColorInput.value;

        // --- Event Listeners ---
        imageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            originalFileName = file.name.split('.').slice(0, -1).join('.') || 'image';
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    currentImage = img;
                    currentRotation = 0;
                    imageOptions.style.display = 'block';
                    downloadAllContainer.style.display = 'block';
                    infoText.style.display = 'none';
                    splitImage();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
        
        // NEW: Update preview div when color changes
        fillColorInput.addEventListener('input', (e) => {
            colorPreview.style.backgroundColor = e.target.value;
        });

        applyColorBtn.addEventListener('click', () => splitImage());
        rotateBtn.addEventListener('click', () => {
            currentRotation = (currentRotation + 90) % 360;
            splitImage();
        });
        sizeSlider.addEventListener('input', () => {
            const newSize = sizeSlider.value;
            sizeLabel.textContent = `${newSize}%`;
            previewContainer.style.width = `${newSize}%`;
        });
        previewToggleBtn.addEventListener('click', () => {
            previewContainer.classList.toggle('preview-cropped');
            const isCropped = previewContainer.classList.contains('preview-cropped');
            previewToggleBtn.textContent = isCropped ? '完整網格' : '預覽裁切';
            previewContainer.style.gap = isCropped ? '0' : '10px';
        });
        downloadAllBtn.addEventListener('click', generateAndDownloadZip);

        function getRotatedImage() {
            if (!currentImage) return null;
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const angleRad = currentRotation * Math.PI / 180;
            const isSwapped = currentRotation === 90 || currentRotation === 270;
            const w = currentImage.width;
            const h = currentImage.height;
            canvas.width = isSwapped ? h : w;
            canvas.height = isSwapped ? w : h;
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate(angleRad);
            ctx.drawImage(currentImage, -w / 2, -h / 2);
            return canvas;
        }

        async function processImageSlices(onSlice) {
            const rotatedImage = getRotatedImage();
            if (!rotatedImage) return;

            const fillColor = fillColorInput.value;
            const isLandscape = rotatedImage.width > rotatedImage.height;

            if (isLandscape) {
                const TARGET_SLICE_ASPECT = 3 / 4;
                const FINAL_ASPECT = 4 / 5;
                const sliceHeight = rotatedImage.height;
                const slice34_Width = sliceHeight * TARGET_SLICE_ASPECT;
                const total34_Width = slice34_Width * COLS;
                const sx_offset = (rotatedImage.width - total34_Width) / 2;

                for (let c = 0; c < COLS; c++) {
                    const finalCanvas = document.createElement('canvas');
                    finalCanvas.height = sliceHeight;
                    finalCanvas.width = sliceHeight * FINAL_ASPECT;
                    const ctx = finalCanvas.getContext('2d');
                    ctx.fillStyle = fillColor;
                    ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
                    const sx = sx_offset + (c * slice34_Width);
                    const dx = (finalCanvas.width - slice34_Width) / 2;
                    ctx.drawImage(rotatedImage, sx, 0, slice34_Width, sliceHeight, dx, 0, slice34_Width, sliceHeight);
                    await onSlice(finalCanvas, c + 1);
                }
            } else {
                const rows = Math.max(1, Math.round((rotatedImage.height / rotatedImage.width) * (COLS * 4 / 5)));
                let imageNumber = 1;
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < COLS; c++) {
                        const sliceWidth = rotatedImage.width / COLS;
                        const sliceHeight = rotatedImage.height / rows;
                        const finalCanvas = document.createElement('canvas');
                        finalCanvas.height = sliceHeight;
                        finalCanvas.width = sliceHeight * (4 / 5);
                        const ctx = finalCanvas.getContext('2d');
                        ctx.fillStyle = fillColor;
                        ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
                        const sx = c * sliceWidth;
                        const sy = r * sliceHeight;
                        const dx = (finalCanvas.width - sliceWidth) / 2;
                        ctx.drawImage(rotatedImage, sx, sy, sliceWidth, sliceHeight, dx, 0, sliceWidth, sliceHeight);
                        await onSlice(finalCanvas, imageNumber);
                        imageNumber++;
                    }
                }
            }
        }

        async function splitImage() {
            if (!currentImage) return;
            previewContainer.innerHTML = '';
            previewContainer.style.width = `${sizeSlider.value}%`;

            let imageElements = [];
            await processImageSlices((canvas, number) => {
                const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
                const gridItem = document.createElement('div');
                gridItem.className = 'grid-item';
                const cropWrapper = document.createElement('div');
                cropWrapper.className = 'crop-wrapper';
                const imgElement = document.createElement('img');
                imgElement.src = dataUrl;
                const downloadLink = document.createElement('a');
                downloadLink.href = dataUrl;
                downloadLink.download = `${originalFileName}_${number}.jpg`;
                downloadLink.className = 'download-btn';
                downloadLink.innerHTML = '⬇';
                cropWrapper.appendChild(imgElement);
                gridItem.appendChild(cropWrapper);
                gridItem.appendChild(downloadLink);
                imageElements.push(gridItem);
            });

            previewContainer.append(...imageElements);
            previewContainer.style.gap = previewContainer.classList.contains('preview-cropped') ? '0' : '10px';
        }

        async function generateAndDownloadZip() {
            if (!currentImage || !window.JSZip) return;
            downloadAllBtn.disabled = true;
            downloadAllBtn.textContent = '打包中...';
            try {
                const zip = new JSZip();
                await processImageSlices(async (canvas, number) => {
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.95));
                    zip.file(`${originalFileName}_${number}.jpg`, blob);
                });
                const zipBlob = await zip.generateAsync({ type: "blob" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(zipBlob);
                link.download = `${originalFileName}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            } catch (error) {
                console.error("建立 ZIP 檔案時發生錯誤:", error);
                alert("建立 ZIP 檔案失敗，請查看控制台以獲取更多資訊。");
            } finally {
                downloadAllBtn.disabled = false;
                downloadAllBtn.textContent = '下載全部 (ZIP)';
            }
        }
    </script>

</body>

</html>

